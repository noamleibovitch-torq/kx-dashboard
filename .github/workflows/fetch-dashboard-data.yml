name: Fetch Dashboard Data

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main # Update data when changes are pushed to main

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Fetch dashboard data from Torq webhook
        env:
          TORQ_WEBHOOK_URL: ${{ secrets.TORQ_WEBHOOK_URL }}
          TORQ_AUTH_SECRET: ${{ secrets.TORQ_AUTH_SECRET }}
        run: |
          # Fetch academy data (7 days)
          echo "ðŸ“Š Fetching academy data..."
          ACADEMY_DATA=$(curl -s -X POST "${TORQ_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${TORQ_AUTH_SECRET}" \
            -d '{"days_back": 7}')
          
          # Fetch documentation data (MTD)
          echo "ðŸ“š Fetching documentation data..."
          DOC_DATA=$(curl -s -X POST "${TORQ_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${TORQ_AUTH_SECRET}" \
            -d '{"doc_period": "mtd"}')
          
          # Merge the data using jq (both should be in the same response, but handle separately if needed)
          # For now, assume the webhook returns combined data
          echo "ðŸ“¥ Processing dashboard data..."
          
          # Add timestamp to the data
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "${ACADEMY_DATA}" | jq --arg ts "${TIMESTAMP}" '. + {timestamp: $ts}' > web-dashboard/data/dashboard.json
          
          echo "âœ… Dashboard data updated successfully"
      
      - name: Commit and push if changed
        run: |
          cd web-dashboard
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/dashboard.json
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "âœ… No changes to dashboard data"
          else
            git commit -m "ðŸ”„ Update dashboard data - $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push
            echo "âœ… Dashboard data committed and pushed"
          fi

